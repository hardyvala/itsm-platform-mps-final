{
  "metadata": {
    "service": "ticket",
    "version": "1.0"
  },
  "nodes": [
    {
      "name": "Ticket",
      "table": "tickets",
      "properties": [
        {
          "name": "id",
          "type": "uuid",
          "primary": true
        },
        {
          "name": "subject",
          "type": "text",
          "required": true,
          "max_length": 255
        },
        {
          "name": "description",
          "type": "text"
        },
        {
          "name": "status",
          "type": "enum",
          "values": [
            "open",
            "in_progress",
            "pending",
            "resolved",
            "closed"
          ],
          "default": "open",
          "indexed": true
        },
        {
          "name": "priority",
          "type": "enum",
          "values": [
            "low",
            "medium",
            "high",
            "critical"
          ],
          "default": "medium",
          "indexed": true
        },
        {
          "name": "customer_id",
          "type": "uuid",
          "required": true,
          "indexed": true
        },
        {
          "name": "assigned_to",
          "type": "uuid",
          "indexed": true
        },
        {
          "name": "due_date",
          "type": "timestamp"
        },
        {
          "name": "resolved_at",
          "type": "timestamp"
        },
        {
          "name": "created_at",
          "type": "timestamp",
          "required": true,
          "default": "now()"
        },
        {
          "name": "updated_at",
          "type": "timestamp",
          "required": true,
          "default": "now()"
        },
        {
          "name": "deleted_at",
          "type": "timestamp"
        }
      ],
      "indexes": [
        {
          "name": "idx_tickets_tenant_status",
          "fields": [
            "tenant_id",
            "status"
          ]
        },
        {
          "name": "idx_tickets_tenant_priority",
          "fields": [
            "tenant_id",
            "priority"
          ]
        },
        {
          "name": "idx_tickets_tenant_customer",
          "fields": [
            "tenant_id",
            "customer_id"
          ]
        }
      ],
      "dal": {
        "soft_delete": true,
        "optimistic_lock": true
      },
      "relations": [
        {
          "name": "customer",
          "type": "belongs_to",
          "target_service": "customer",
          "target_node": "Customer",
          "local_field": "customer_id",
          "target_field": "id"
        },
        {
          "name": "comments",
          "type": "has_many",
          "target_service": "ticket",
          "target_node": "Comment",
          "local_field": "id",
          "target_field": "ticket_id"
        }
      ],
      "hooks": {
        "pre_create": {
          "enabled": true,
          "validations": [
            {
              "field": "subject",
              "rule": "min_length",
              "value": 5,
              "message": "Subject must be at least 5 characters"
            },
            {
              "field": "customer_id",
              "rule": "required",
              "message": "Customer is required"
            }
          ]
        },
        "post_create": {
          "enabled": true,
          "actions": [
            "notifyCustomer",
            "autoAssignTicket",
            "calculateSLA"
          ]
        },
        "pre_update": {
          "enabled": true,
          "rules": [
            {
              "condition": "old.status == 'closed' && new.status != 'closed'",
              "action": "reject",
              "message": "Cannot reopen closed ticket"
            }
          ]
        },
        "post_update": {
          "enabled": true,
          "triggers": [
            {
              "on_field_change": "status",
              "action": "notifyStatusChange"
            },
            {
              "on_field_change": "assigned_to",
              "action": "notifyAssignment"
            }
          ]
        },
        "pre_delete": {
          "enabled": true
        },
        "post_delete": {
          "enabled": true,
          "actions": [
            "cleanup"
          ]
        }
      },
      "graph": {
        "label": "Ticket",
        "sync_properties": [
          "id",
          "tenant_id",
          "subject",
          "status",
          "priority"
        ],
        "edges": [
          {
            "type": "REPORTED_BY",
            "to": "Customer",
            "via": "customer_id"
          },
          {
            "type": "ASSIGNED_TO",
            "to": "Agent",
            "via": "assigned_to"
          }
        ]
      }
    },
    {
      "name": "Comment",
      "table": "comments",
      "properties": [
        {
          "name": "id",
          "type": "uuid",
          "primary": true
        },
        {
          "name": "ticket_id",
          "type": "uuid",
          "required": true,
          "indexed": true
        },
        {
          "name": "body",
          "type": "text",
          "required": true
        },
        {
          "name": "author_id",
          "type": "uuid",
          "required": true,
          "indexed": true
        },
        {
          "name": "author_type",
          "type": "enum",
          "values": [
            "agent",
            "customer",
            "system"
          ],
          "required": true
        },
        {
          "name": "is_internal",
          "type": "boolean",
          "default": false
        },
        {
          "name": "created_at",
          "type": "timestamp",
          "required": true,
          "default": "now()"
        },
        {
          "name": "updated_at",
          "type": "timestamp",
          "required": true,
          "default": "now()"
        },
        {
          "name": "deleted_at",
          "type": "timestamp"
        }
      ],
      "indexes": [
        {
          "name": "idx_comments_tenant_ticket",
          "fields": [
            "tenant_id",
            "ticket_id"
          ]
        }
      ],
      "dal": {
        "soft_delete": true,
        "optimistic_lock": false
      },
      "relations": [
        {
          "name": "ticket",
          "type": "belongs_to",
          "target_service": "ticket",
          "target_node": "Ticket",
          "local_field": "ticket_id",
          "target_field": "id"
        }
      ],
      "hooks": {
        "pre_create": {
          "enabled": true,
          "validations": [
            {
              "field": "body",
              "rule": "min_length",
              "value": 1,
              "message": "Comment body is required"
            }
          ]
        },
        "post_create": {
          "enabled": true,
          "actions": [
            "updateTicketTimestamp",
            "notifyWatchers"
          ]
        },
        "pre_update": {
          "enabled": false
        },
        "post_update": {
          "enabled": false
        },
        "pre_delete": {
          "enabled": false
        },
        "post_delete": {
          "enabled": false
        }
      },
      "graph": {
        "label": "Comment",
        "sync_properties": [
          "id",
          "tenant_id",
          "created_at"
        ],
        "edges": [
          {
            "type": "BELONGS_TO",
            "to": "Ticket",
            "via": "ticket_id"
          }
        ]
      }
    }
  ],
  "events": {
    "stream": "TICKET_EVENTS",
    "publish": [
      {
        "event": "ticket.created",
        "subject": "ticket.{tenant_id}.ticket.created"
      },
      {
        "event": "ticket.updated",
        "subject": "ticket.{tenant_id}.ticket.updated"
      },
      {
        "event": "ticket.deleted",
        "subject": "ticket.{tenant_id}.ticket.deleted"
      },
      {
        "event": "ticket.status_changed",
        "subject": "ticket.{tenant_id}.ticket.status_changed"
      },
      {
        "event": "comment.created",
        "subject": "ticket.{tenant_id}.comment.created"
      },
      {
        "event": "comment.updated",
        "subject": "ticket.{tenant_id}.comment.updated"
      }
    ],
    "subscribe": [
      {
        "subject": "customer.*.customer.updated",
        "handler": "on_customer_updated"
      },
      {
        "subject": "customer.*.customer.deleted",
        "handler": "on_customer_deleted"
      }
    ]
  }
}
