{
  "version": "2.0",
  "kind": "ServiceGraph",
  "metadata": {
    "service": "customer",
    "namespace": "platform.customer",
    "database": "customer_db"
  },

  "platform": {
    "defaults": {
      "id_strategy": "uuid_v7",
      "id_fallback": "uuid_v4",
      "timestamps": {
        "created_at": true,
        "updated_at": true,
        "deleted_at": true
      },
      "soft_delete": {
        "enabled": true,
        "strategy": "timestamp"
      },
      "versioning": {
        "enabled": true,
        "field": "version",
        "optimistic_locking": true
      },
      "audit": {
        "enabled": true,
        "track_changes": true
      },
      "tenant": {
        "isolation": "schema",
        "column": "tenant_id"
      }
    },
    "messaging": {
      "provider": "nats",
      "jetstream": true,
      "url": "nats://nats-1:6222",
      "subject_pattern": "platform.${app}.${tenant}.${entity}.${action}"
    },
    "database": {
      "type": "postgresql",
      "version": "18",
      "extensions": ["age", "pg_trgm", "pgvector", "uuid-ossp"]
    }
  },

  "nodes": [
    {
      "name": "Customer",
      "table": "customers",
      "schema": "${tenant_schema}",
      "description": "Customer/Contact for CRM",
      "properties": [
        {"name": "id", "type": "uuid", "primary": true, "generator": "uuid_v7"},
        {"name": "tenant_id", "type": "uuid", "required": true, "indexed": "btree", "immutable": true},
        {"name": "customer_number", "type": "text", "unique": true, "indexed": "btree", "auto_generate": {"strategy": "sequence", "format": "CUST-${SEQ:8}"}},
        {"name": "name", "type": "text", "required": true, "max_length": 255, "searchable": true, "indexed": "btree"},
        {"name": "email", "type": "text", "required": true, "unique_per_tenant": true, "validation": "email", "indexed": "btree"},
        {"name": "phone", "type": "text", "max_length": 20, "nullable": true},
        {"name": "company", "type": "text", "max_length": 255, "nullable": true, "indexed": "btree"},
        {"name": "plan", "type": "enum", "values": ["free", "starter", "professional", "enterprise"], "default": "free", "indexed": "btree"},
        {"name": "status", "type": "enum", "values": ["active", "inactive", "churned", "prospect"], "default": "active", "indexed": "btree"},
        {"name": "lifetime_value", "type": "decimal", "precision": 15, "scale": 2, "default": 0},
        {"name": "timezone", "type": "text", "max_length": 50, "default": "UTC"},
        {"name": "preferences", "type": "jsonb", "nullable": true},
        {"name": "metadata", "type": "jsonb", "nullable": true},
        {"name": "custom_fields", "type": "jsonb", "nullable": true},
        {"name": "created_at", "type": "timestamptz", "required": true, "default": "now()"},
        {"name": "updated_at", "type": "timestamptz", "required": true, "default": "now()"},
        {"name": "deleted_at", "type": "timestamptz", "nullable": true},
        {"name": "version", "type": "integer", "default": 1}
      ],
      "references": [
        {"name": "organization_id", "type": "uuid", "nullable": true, "indexed": "btree", "local_ref": "Organization.id"}
      ],
      "indexes": [
        {"name": "idx_customers_tenant_email", "fields": ["tenant_id", "email"], "unique": true},
        {"name": "idx_customers_tenant_plan", "fields": ["tenant_id", "plan", "status"]},
        {"name": "idx_customers_tenant_active", "fields": ["tenant_id", "status"], "where": "status = 'active'"},
        {"name": "idx_customers_search", "type": "gin", "expression": "to_tsvector('english', coalesce(name, '') || ' ' || coalesce(email, '') || ' ' || coalesce(company, ''))"}
      ],
      "validations": [
        {"name": "valid_email", "condition": "email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\\\.[A-Za-z]{2,}$'", "message": "Invalid email format"}
      ],
      "dal": {
        "soft_delete": true,
        "optimistic_lock": true
      },
      "relations": [
        {
          "name": "organization",
          "type": "belongs_to",
          "target_service": "customer",
          "target_node": "Organization",
          "local_field": "organization_id",
          "target_field": "id"
        }
      ],
      "hooks": {
        "pre_create": {
          "enabled": true,
          "validations": [
            {"field": "email", "rule": "email_format", "message": "Invalid email format"},
            {"field": "name", "rule": "min_length", "value": 2, "message": "Name must be at least 2 characters"}
          ]
        },
        "post_create": {
          "enabled": true,
          "actions": ["sendWelcomeEmail"]
        },
        "pre_update": {
          "enabled": true,
          "validations": [
            {"field": "email", "rule": "email_format", "message": "Invalid email format"}
          ]
        },
        "post_update": {
          "enabled": true,
          "triggers": [
            {"on_field_change": "email", "action": "sendEmailChangeNotification"},
            {"on_field_change": "plan", "action": "notifyPlanChange"}
          ]
        },
        "pre_delete": {
          "enabled": true,
          "checks": ["has_no_open_tickets"],
          "prevent_if": [
            {
              "condition": "EXISTS (SELECT 1 FROM ticket_service.tickets WHERE reporter_id = customers.id AND status NOT IN ('resolved', 'closed'))",
              "message": "Cannot delete customer with open tickets"
            }
          ]
        },
        "post_delete": {
          "enabled": true,
          "actions": ["anonymizeData"]
        }
      },
      "crud": {
        "create": {
          "graph_node": true,
          "graph_edges": true,
          "emit_event": true
        },
        "update": {
          "sync_graph": true,
          "emit_event": true
        },
        "delete": {
          "soft_delete": true,
          "sync_graph": true,
          "emit_event": true
        },
        "read": {
          "default_limit": 50,
          "max_limit": 500
        }
      },
      "views": [
        {"name": "active_customers", "filter": "status = 'active'", "sort": ["-created_at"]},
        {"name": "enterprise_customers", "filter": "plan = 'enterprise' AND status = 'active'", "sort": ["name"]},
        {"name": "churned_customers", "filter": "status = 'churned'", "sort": ["-updated_at"]}
      ],
      "graph": {
        "label": "Customer",
        "sync": true,
        "sync_properties": ["id", "tenant_id", "customer_number", "name", "email", "plan", "status"],
        "edges": [
          {"type": "BELONGS_TO_ORG", "to": "Organization", "via": "organization_id", "direction": "out"}
        ]
      }
    },
    {
      "name": "Organization",
      "table": "organizations",
      "schema": "${tenant_schema}",
      "description": "Organization entity for grouping customers",
      "properties": [
        {"name": "id", "type": "uuid", "primary": true, "generator": "uuid_v7"},
        {"name": "tenant_id", "type": "uuid", "required": true, "indexed": "btree", "immutable": true},
        {"name": "name", "type": "text", "required": true, "max_length": 255, "searchable": true, "indexed": "btree"},
        {"name": "domain", "type": "text", "nullable": true, "indexed": "btree"},
        {"name": "industry", "type": "text", "nullable": true},
        {"name": "size", "type": "enum", "values": ["small", "medium", "large", "enterprise"], "nullable": true},
        {"name": "metadata", "type": "jsonb", "nullable": true},
        {"name": "created_at", "type": "timestamptz", "required": true, "default": "now()"},
        {"name": "updated_at", "type": "timestamptz", "required": true, "default": "now()"},
        {"name": "deleted_at", "type": "timestamptz", "nullable": true},
        {"name": "version", "type": "integer", "default": 1}
      ],
      "indexes": [
        {"name": "idx_organizations_tenant_name", "fields": ["tenant_id", "name"]},
        {"name": "idx_organizations_tenant_domain", "fields": ["tenant_id", "domain"], "unique": true, "where": "domain IS NOT NULL"}
      ],
      "dal": {
        "soft_delete": true,
        "optimistic_lock": true
      },
      "relations": [
        {
          "name": "customers",
          "type": "has_many",
          "target_service": "customer",
          "target_node": "Customer",
          "local_field": "id",
          "target_field": "organization_id"
        }
      ],
      "crud": {
        "create": {
          "graph_node": true,
          "emit_event": true
        },
        "update": {
          "sync_graph": true,
          "emit_event": true
        },
        "delete": {
          "soft_delete": true,
          "sync_graph": true,
          "emit_event": true
        },
        "read": {
          "default_limit": 50,
          "max_limit": 500,
          "include": ["customers"]
        }
      },
      "graph": {
        "label": "Organization",
        "sync": true,
        "sync_properties": ["id", "tenant_id", "name", "domain"]
      }
    }
  ],

  "events": {
    "stream": "PLATFORM_EVENTS",
    "publish": [
      {"event": "customer.created", "subject": "platform.customer.${tenant_id}.customer.created"},
      {"event": "customer.updated", "subject": "platform.customer.${tenant_id}.customer.updated"},
      {"event": "customer.deleted", "subject": "platform.customer.${tenant_id}.customer.deleted"},
      {"event": "organization.created", "subject": "platform.customer.${tenant_id}.organization.created"},
      {"event": "organization.updated", "subject": "platform.customer.${tenant_id}.organization.updated"},
      {"event": "organization.deleted", "subject": "platform.customer.${tenant_id}.organization.deleted"}
    ],
    "subscribe": []
  }
}